<html><body>

<button onClick="listFiles()">Select Directory</button>

<ul id="carList"></ul>

<script type="text/javascript">
  var carList = document.getElementById("carList");
  var allAlloweds = [];
  var fileHandles = {};
  
  async function addCar(carName, directoryHandle, entry) {

    var configNumber = getConfigNumber(entry.name);
    const fileHandle = await directoryHandle.getFileHandle(entry.name);
    var alloweds = await readContents(carName + configNumber, fileHandle);
    var listItem = addCarListItem(carName, configNumber);
    
    addAlloweds(carName, listItem, alloweds);
  }
  
  function addAlloweds(carName, listItem, alloweds) {
    if(alloweds != null && alloweds.length > 0) {
      alloweds.forEach(function(allowed) {
        if(allowed.indexOf("Order") == 0) return;
        
        if(!allAlloweds.includes(allowed)) allAlloweds.push(allowed);
      });
      addCheckboxes(carName, listItem, alloweds);
    }
  }
  
  async function readContents(carName, fileHandle) {
    const file = await fileHandle.getFile();
    const contents = await file.text();
    const lines = contents.split('\n');
    if(lines.length > 0) {
      for(var lineNumber in lines) {
        var line = lines[lineNumber];
        if(line.indexOf("allowedPlaces") == 0) {
          var allowed = line.split("=")[1];
          // console.log(`${carName} allowed in ${allowed}`);
          
          var allowedItems = allowed.split(",");
          
          fileHandles[carName] = {
            "handle": fileHandle,
            "contents": contents,
            "currentAllowedLine": line,
            "allowedOrders": getAllowedOrders(allowedItems)
          };
          
          return allowedItems;
        }
      }
    }
  }
  
  function getAllowedOrders(allowedItems) {
    var allowedOrders = [];
    for(var index in allowedItems) {
      var item = allowedItems[index];
      if(item.indexOf("Order") == 0) allowedOrders.push(item);
    }
    
    return allowedOrders;
  }
                                        
  function addCarListItem(name, configNumber) {    
    const item = document.createElement("li");
    item.innerHTML = `${name} <br />`;
    if(configNumber != null) item.innerHTML += configNumber;
    carList.appendChild(item);
    
    return item;
  }
  
  function addCheckboxes(carName, node, alloweds) {
    ["Auction", "Salon", "Junkyard", "Shed"].forEach(function(place) {
      var isAllowed = alloweds.includes(place);
      addCheckBox(carName, node, place, isAllowed);
    });
  }
  
  function addCheckBox(carName, node, text, isChecked) {
    const check = document.createElement("input");
    const label = document.createElement("label");
    check.onChange = allowedChecked(this, "derp", event);
    check.id = carName + text;
    label.innerHTML = text;
    label.for = check.id;
    check.type = "checkbox";
    check.checked = isChecked;
    node.appendChild(check);   
    node.appendChild(label);    
  }
  
  function allowedChecked(one, two, three, four) {
    console.log(one);
    console.log(two);
    console.log(three);
    console.log(four);
  }
  
  function getConfigNumber(name) {
    
    if(name.indexOf("config") != 0) return null;
    return name.replace("config", "").replace(".txt", "");
  }
  
  async function writeFile(fileHandle, contents) {
    // Create a FileSystemWritableFileStream to write to.
    const writable = await fileHandle.createWritable();
    // Write the contents of the file to the stream.
    await writable.write(contents);
    // Close the file and write the contents to disk.
    await writable.close();
  }
  
  async function listFiles() {
      const dirHandle = await window.showDirectoryPicker();
      for await (const entry of dirHandle.values()) {
        if(entry.kind == "directory") {
          var configCount = 0;
          var subDir = await dirHandle.getDirectoryHandle(entry.name);
          for await (const subEntry of subDir.values()) {
            if(subEntry.name.indexOf("config") == 0) await addCar(entry.name, subDir, subEntry);
          }
        }
      }
    
    console.log(allAlloweds);
    console.log(fileHandles);
  }
  
  listFiles();
</script>

  </body></html>
